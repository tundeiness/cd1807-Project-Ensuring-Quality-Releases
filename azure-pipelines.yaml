name: Azure Pipelines

trigger:
  - main

pool:
  name: myAgentPool

variables:
  - group: azure-credentials
  - name: python.version
    value: '3.8.10'
  - name: azureServiceConnectionId
    value: 'myConnex'
  - name: projectRoot
    value: $(System.DefaultWorkingDirectory)
  - name: environmentName
    value: 'test'
  # - name: webAppName
  #   value: 'udacityApp-AppService-app-2158f50c'

stages:
  #--------------------------------------------#
  # BUILD STAGE
  #--------------------------------------------#
  - stage: Build
    displayName: Build Stage
    jobs:
      - job: BuildInfrastructure
        displayName: Terraform | Provision / Refresh Infra
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Terraform installation'
            inputs:
              terraformVersion: '1.2.9'

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
            displayName: 'Terraform init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
              backendServiceArm: '$(azureServiceConnectionId)'
              backendAzureRmResourceGroupName: 'Azuredevops'
              backendAzureRmStorageAccountName: 'tfstate571125123'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'test.terraform.tfstate'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              TF_VAR_ssh_public_key: $(SSH_PUBLIC_KEY)

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
            displayName: 'Terraform validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'

          - task: DownloadSecureFile@1
            name: sshKey
            displayName: 'Download SSH Private Key'
            inputs:
              secureFile: 'id_rsa'

          - task: InstallSSHKey@0
            displayName: 'Install SSH Key for VM Access'
            inputs:
              knownHostsEntry: '$(KNOWN_HOSTS_STRING)'
              sshPublicKey: '$(SSH_PUBLIC_KEY)'
              sshKeySecureFile: 'id_rsa'

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
            displayName: 'Terraform plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
              environmentServiceNameAzureRM: '$(azureServiceConnectionId)'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              TF_VAR_ssh_public_key: $(SSH_PUBLIC_KEY)

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
            displayName: 'Terraform apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
              environmentServiceNameAzureRM: '$(azureServiceConnectionId)'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              TF_VAR_ssh_public_key: $(SSH_PUBLIC_KEY)

      - job: PostmanTests
        displayName: Postman | API Tests
        dependsOn: BuildInfrastructure
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '16.x'

          - task: CmdLine@2
            displayName: 'Install Newman'
            inputs:
              script: |
                npm install -g newman
              workingDirectory: '$(System.DefaultWorkingDirectory)'

          - task: CmdLine@2
            displayName: 'Run Regression Tests'
            inputs:
              script: |
                newman run TestSuite.Regression.json \
                  -e Test.environment.json \
                  --reporters cli,junit \
                  --reporter-junit-export TEST-Regression.xml
            workingDirectory: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'

          - task: CmdLine@2
            displayName: 'Run Data Validation Tests'
            inputs:
              script: |
                newman run TestSuite.Data-Validation.json \
                  -e Test.environment.json \
                  --reporters cli,junit \
                  --reporter-junit-export TEST-DataValidation.xml
            workingDirectory: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'

          - task: PublishTestResults@2
            displayName: 'Publish Postman Regression Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'TEST-Regression.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'
              failTaskOnFailedTests: false
              testRunTitle: 'API Regression Tests'
              publishRunAttachments: true

          - task: PublishTestResults@2
            displayName: 'Publish Postman Data Validation Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'TEST-DataValidation.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)/automatedtesting/postman'
              failTaskOnFailedTests: false
              testRunTitle: 'API Data Validation Tests'
              publishRunAttachments: true

      - job: ArchiveArtifacts
        displayName: Archive | Publish Build Artifacts
        dependsOn: PostmanTests
        steps:
          - task: ArchiveFiles@2
            displayName: 'Archive Selenium UI Tests'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
              replaceExistingArchive: true

          - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
            displayName: 'Publish Selenium UI Tests Package'
            artifact: drop-uitests

          - task: ArchiveFiles@2
            displayName: 'Archive FakeRestAPI'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/jmeter/fakerestapi'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip'
              replaceExistingArchive: true

          - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip'
            displayName: 'Publish FakeRestAPI Package'
            artifact: drop-fakerestapi

          - task: ArchiveFiles@2
            displayName: 'Archive JMeter Performance Tests'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/jmeter/test-suite'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip'
              replaceExistingArchive: true

          - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-perftests.zip'
            displayName: 'Publish JMeter Performance Tests Package'
            artifact: drop-perftests

  # #--------------------------------------------#
  # # DEPLOY STAGE
  # #--------------------------------------------#
  # - stage: Deploy
  #   displayName: Deploy Stage
  #   jobs:
  #     - deployment: DeployFakeRestAPI
  #       displayName: Deploy | FakeRestAPI to Web App
  #       environment: $(environmentName)
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               - download: current
  #                 artifact: drop-fakerestapi
  #                 displayName: 'Download FakeRestAPI Artifact'

  #               - task: AzureWebApp@1
  #                 displayName: 'Deploy FakeRestAPI to Azure Web App'
  #                 inputs:
  #                   azureSubscription: '$(azureServiceConnectionId)'
  #                   appName: '$(webAppName)'
  #                   appType: 'webApp'
  #                   package: '$(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip'
  #                   deploymentMethod: 'zipDeploy'

  #     - deployment: RunJMeterTests
  #       displayName: Test | JMeter Performance
  #       dependsOn: DeployFakeRestAPI
  #       environment: $(environmentName)
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               - download: current
  #                 artifact: drop-perftests
  #                 displayName: 'Download JMeter Test Suite'

  #               - task: Bash@3
  #                 displayName: 'Install Java + Apache JMeter'
  #                 inputs:
  #                   targetType: 'inline'
  #                   workingDirectory: '$(Pipeline.Workspace)'
  #                   script: |
  #                     set -euo pipefail
  #                     sudo apt-get update -y
  #                     sudo apt-get install -y openjdk-17-jre-headless unzip tar wget
  #                     export JAVA_HOME="$(dirname "$(dirname "$(readlink -f "$(command -v java)")")")"
  #                     export PATH="$JAVA_HOME/bin:$PATH"
  #                     java -version

  #                     TOOLS_DIR="$(Pipeline.Workspace)/tools"
  #                     mkdir -p "$TOOLS_DIR"
  #                     cd "$TOOLS_DIR"

  #                     if [[ ! -d apache-jmeter-5.5 ]]; then
  #                       wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
  #                       tar -xzf apache-jmeter-5.5.tgz
  #                     fi

  #                     "$TOOLS_DIR/apache-jmeter-5.5/bin/jmeter" -v

  #               - task: Bash@3
  #                 displayName: 'Run JMeter Stress Test Suite'
  #                 inputs:
  #                   targetType: 'inline'
  #                   workingDirectory: '$(Pipeline.Workspace)/drop-perftests'
  #                   script: |
  #                     set -euo pipefail
  #                     export JAVA_HOME="$(dirname "$(dirname "$(readlink -f "$(command -v java)")")")"
  #                     export PATH="$JAVA_HOME/bin:$PATH"
  #                     JMETER="$(Pipeline.Workspace)/tools/apache-jmeter-5.5/bin/jmeter"

  #                     ZIP_FILE="$(ls -1 *.zip 2>/dev/null | head -n 1 || true)"
  #                     if [[ -z "${ZIP_FILE}" ]]; then
  #                       echo "No .zip found in $(pwd)"
  #                       ls -la
  #                       exit 1
  #                     fi
  #                     unzip -o "$ZIP_FILE"

  #                     rm -rf stress-test-report
  #                     rm -f stress-test.log stress-test-results.jtl

  #                     "$JMETER" -n \
  #                       -t StressTestSuite.jmx \
  #                       -l stress-test-results.jtl \
  #                       -j stress-test.log \
  #                       -e -o stress-test-report

  #                     mkdir -p "$(Build.ArtifactStagingDirectory)"
  #                     tar -czf "$(Build.ArtifactStagingDirectory)/stress-test-report.tar.gz" stress-test-report

  #               - task: Bash@3
  #                 displayName: 'Run JMeter Endurance Test Suite'
  #                 inputs:
  #                   targetType: 'inline'
  #                   workingDirectory: '$(Pipeline.Workspace)/drop-perftests'
  #                   script: |
  #                     set -euo pipefail
  #                     export JAVA_HOME="$(dirname "$(dirname "$(readlink -f "$(command -v java)")")")"
  #                     export PATH="$JAVA_HOME/bin:$PATH"
  #                     JMETER="$(Pipeline.Workspace)/tools/apache-jmeter-5.5/bin/jmeter"

  #                     rm -rf endurance-test-report
  #                     rm -f endurance-test.log endurance-test-results.jtl

  #                     "$JMETER" -n \
  #                       -t EnduranceTestSuite.jmx \
  #                       -l endurance-test-results.jtl \
  #                       -j endurance-test.log \
  #                       -e -o endurance-test-report

  #                     mkdir -p "$(Build.ArtifactStagingDirectory)"
  #                     tar -czf "$(Build.ArtifactStagingDirectory)/endurance-test-report.tar.gz" endurance-test-report

  #               - publish: $(Build.ArtifactStagingDirectory)
  #                 displayName: 'Publish JMeter HTML Reports'
  #                 artifact: jmeter-reports

  #     #--------------------------------------------#
  #     # Selenium: write log to a stable VM path for Azure Monitor ingestion
  #     #--------------------------------------------#
  #     - deployment: RunSeleniumTests
  #       displayName: Test | Selenium UI on VM
  #       dependsOn:
  #         - DeployFakeRestAPI
  #         - RunJMeterTests
  #       environment: $(environmentName)
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               - download: current
  #                 artifact: drop-uitests
  #                 displayName: 'Download Selenium Test Suite'

  #               - task: Bash@3
  #                 displayName: 'Setup Selenium Test Environment'
  #                 inputs:
  #                   targetType: 'inline'
  #                   script: |
  #                     set -euo pipefail
  #                     sudo apt-get update -y
  #                     sudo apt-get install -y python3-pip python3-venv unzip
  #                     sudo apt-get install -y chromium-browser chromium-chromedriver || true
  #                     sudo apt-get install -y chromium-driver chromium || true
  #                     pip3 install --upgrade pip
  #                     pip3 install selenium pytest pytest-html

  #               #--------------------------------------------#
  #               # Selenium: Execute tests and copy logs for publishing
  #               #--------------------------------------------#
  #               - task: Bash@3
  #                 displayName: 'Execute Selenium UI Test Suite (write VM log + copy for artifacts)'
  #                 inputs:
  #                   targetType: 'inline'
  #                   workingDirectory: $(Agent.HomeDirectory)
  #                   script: |
  #                     set -euo pipefail

  #                     APP_DIR="$HOME/app"
  #                     mkdir -p "$APP_DIR"

  #                     cp "$(Pipeline.Workspace)/drop-uitests/$(Build.BuildId)-uitests.zip" "$APP_DIR/"
  #                     cd "$APP_DIR"
  #                     unzip -o "$(Build.BuildId)-uitests.zip"

  #                     # Create log directory for Azure Monitor ingestion
  #                     sudo mkdir -p /var/log/selenium
  #                     sudo chown "$(id -u):$(id -g)" /var/log/selenium
  #                     sudo chmod 755 /var/log/selenium

  #                     LOG_VM="/var/log/selenium/selenium-test.log"

  #                     echo "======================================" | tee "$LOG_VM"
  #                     echo "BuildId: $(Build.BuildId)"            | tee -a "$LOG_VM"
  #                     echo "StartTimeUtc: $(date -u '+%Y-%m-%dT%H:%M:%SZ')" | tee -a "$LOG_VM"
  #                     echo "======================================" | tee -a "$LOG_VM"

  #                     python3 login.py 2>&1 | tee -a "$LOG_VM"

  #                     echo "======================================" | tee -a "$LOG_VM"
  #                     echo "EndTimeUtc: $(date -u '+%Y-%m-%dT%H:%M:%SZ')" | tee -a "$LOG_VM"
  #                     echo "======================================" | tee -a "$LOG_VM"

  #                     mkdir -p "$(Build.ArtifactStagingDirectory)"
  #                     cp "$LOG_VM" "$(Build.ArtifactStagingDirectory)/selenium-test.log"

  #                     # Optional: Ensure UTF-8 (Azure ingestion can reject non-UTF8)
  #                     if command -v iconv >/dev/null 2>&1; then
  #                       iconv -f UTF-8 -t UTF-8 "$(Build.ArtifactStagingDirectory)/selenium-test.log" \
  #                         -o "$(Build.ArtifactStagingDirectory)/selenium-test.log.utf8" || true
  #                       if [[ -s "$(Build.ArtifactStagingDirectory)/selenium-test.log.utf8" ]]; then
  #                         mv "$(Build.ArtifactStagingDirectory)/selenium-test.log.utf8" \
  #                            "$(Build.ArtifactStagingDirectory)/selenium-test.log"
  #                       fi
  #                     fi

  #               - publish: $(Build.ArtifactStagingDirectory)/selenium-test.log
  #                 displayName: 'Publish Selenium Logs'
  #                 artifact: selenium-logs
  #                 condition: always()
